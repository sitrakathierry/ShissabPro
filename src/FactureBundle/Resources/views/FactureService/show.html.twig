{% extends 'base.html.twig' %}
{% block stylesheets %}
  {{ parent() }}
{% endblock  %}
{% block scripts %}
  {{ parent() }}
  <script src="{{ asset('js/plugins/select2/select2.full.min.js') }}"></script>
  <script src="{{ asset('bundles/facture/js/facture-service-add.js') }}"></script>
  <script src="{{ asset('bundles/facture/js/show.js') }}"></script>
{% endblock %}
{% block contenu %}
<div class="wrapper wrapper-content">
  <div class="row">
    <div class="col-lg-12">
      <div class="ibox float-e-margins">
        <div class="ibox-title">
          <h5>
            Facture N° <span class="badge-warning">{{facture.formattedNum}}</span>
            {% if facture.type == 1 %}
                {% if definitif %}
                    <a href="{{ path('facture_show', { id : definitif.id }) }}" class="btn btn-xs btn-outline btn-info" target="_blank">
                        <i class="fa fa-file"></i>
                        Voir Fact. DEFINITIF
                    </a>
                {% else %}
                    <button class="btn btn-xs btn-outline btn-primary" id="creer-definitif">
                        <div class="fa fa-copy"></div>
                        Créer Fact. DEFINITIF
                    </button>
                {% endif %}
            {% else %}
                {% if facture.proforma %}
                     <a href="{{ path('facture_show', { id : facture.proforma.id }) }}" class="btn btn-xs btn-outline btn-info" target="_blank">
                        <i class="fa fa-file"></i>
                        Voir Fact. PROFORMA
                    </a>
                {% endif %}
            {% endif %}
          </h5>
          {# <div class="ibox-tools">
	            <a href="{{ path('facture_pdf', { id : facture.id }) }}" class="btn btn-primary btn-xs btn-print" target="_blank">
	                <i class="fa fa-print"></i> Imprimer
	            </a>
        	</div> #}
        </div>
        <div class="ibox-content">
          <form method="POST" action="{{ path('facture_service_save') }}" class="form-horizontal">

          	<input type="hidden" name="f_id" id="f_id" value="{{ facture.id }}">

          	<div class="form-group">
              <label class="col-sm-2 control-label">MODELE</label>
              <div class="col-sm-10">
                <select class="form-control m-b" name="f_model" id="f_model" required="">
                  <option value=""></option>
                  <option value="1" {% if facture.modele == 1 %}selected=""{% endif %}>PRODUIT</option>
                  <option value="2" {% if facture.modele == 2 %}selected=""{% endif %}>SERVICE</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">FACTURE</label>
              <div class="col-sm-10">
                <select class="form-control m-b" name="f_type" required="">
                  <option value="1" {% if facture.type == 1 %}selected=""{% endif %}>PROFORMA</option>
                  <option value="2" {% if facture.type == 2 %}selected=""{% endif %}>DEFINITIVE</option>
                </select>
              </div>
            </div>


            {% if facture.client.statut == 1%}
              <div class="form-group">
                <label class="col-sm-2 control-label">Client</label>
                <div class="col-sm-10">
                  <input class="form-control" readonly="" type="text" value="{{facture.client.idClientMorale.nomSociete}}" name="">
                </div>
              </div>
              
            {% else %}
              <div class="form-group">
                <label class="col-sm-2 control-label">Client</label>
                <div class="col-sm-10">
                  <input class="form-control" readonly="" type="text" value="{{facture.client.idClientPhysique.nom}}" name="">
                </div>
              </div>
            {% endif %}
            <input type="hidden" value="{{facture.client.numPolice}}" name="f_client">
            <input type="hidden" value="" name="f_nom">

            <div class="form-group">
                <div class="col-sm-12">
                    <textarea id="descr" name="descr">
                      {{ facture.descr | raw }}
                    </textarea>
                </div>
            </div>

            <div class="hr-line-dashed"></div>
            <table class="table table-bordered" id="table-fact-add">
              <thead class="thead-dark">
                <tr>
                  <th scope="col">DESIGNATION</th>
			      <th scope="col">PERIODE</th>
			      <th scope="col">DUREE</th>
			      <th scope="col">PRIX</th>
			      <th scope="col">MONTANT TOTAL</th>
			      <th scope="col"></th>
                </tr>
              </thead>
              <tbody>

              	{% set i = 0 %}
                {% set total = 0 %}
                {% set list_id = "" %}

                {% for detail in details %}

                	{% if list_id == "" %}
                        {% set list_id = detail.id %}
                    {% else %}
                        {% set list_id = list_id ~ "," ~ detail.id %}
                    {% endif %}

	                <tr data-id="{{i}}">
	                  <td>
	                    <div class="form-group">
	                      <div class="col-sm-10">
	                        <select class="form-control f_service" name="f_service[]">
				              <option></option>
				              {% for service in services %}
				                <option 
				                	value="{{service.id}}"
				                	{% if detail.service.id == service.id %}
				                		selected=""
				                	{% endif %} 
				                >{{service.nom}}</option>
				              {% endfor %}
				            </select>
	                      </div>
	                    </div>
	                  </td>
	                  <td>
                      <div class="form-group">
                        <div class="col-sm-10">
                          <input type="number" class="form-control f_service_periode" name="f_service_periode[]" value="{{detail.periode}}" >
                        </div>
                      </div>
                    </td>
                    <td>
				        <div class="form-group">
				          <div class="col-sm-10">
				            <select class="form-control f_service_duree" name="f_service_duree[]">
				              <option></option>
				              <option value="1">Heure</option>
				              <option value="2">Jour</option>
				              <option value="3">Mois</option>
				              <option value="4">Année</option>
				            </select>
				          </div>
				        </div>
				      </td>
                    <td>
	                    <div class="form-group">
	                      <div class="col-sm-10">
	                        <input type="number" class="form-control f_service_prix" name="f_service_prix[]" value="{{detail.prix}}" required="">
	                      </div>
	                    </div>
	                  </td>
	                  <td>
	                    <div class="form-group">
	                      <div class="col-sm-10">
	                        <input type="number" class="form-control f_service_montant" name="f_service_montant[]" value="{{detail.montant}}" required="">
	                      </div>
	                    </div>
	                  </td>
	                  
	                  <td>
	                  </td>
	                </tr>

	                {% set i = i + 1 %}
                    
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="3">Montant</th>
                  <th>
                    <div class="form-group">
                      <div class="col-sm-10">
                        <input type="number" class="form-control" name="service_montant" id="service_montant" readonly="" value="{{facture.montant}}">
                      </div>
                    </div>
                    
                  </th>
                  <th>
                    <span class="btn-remove-row-service" data-id="0"><i class="fa fa-trash"></i></span>&nbsp;
                    <span class="btn-add-row-service" data-id="0"><i class="fa fa-plus"></i></span>
                  </th>
                </tr>
                <tr>
                  <th colspan="2">Remise (en %)</th>
                  <th>
                    <div class="form-group">
                      <div class="col-sm-10">
                        <input type="number" class="form-control" id="f_service_remise" name="f_service_remise" required="" value="{{facture.remisePourcentage}}">
                      </div>
                    </div>
                  </th>
                  <th id="">
                    <div class="form-group">
                      <div class="col-sm-10">
                        <input type="number" class="form-control" name="service_remise" id="service_remise" readonly="" value="{{facture.remiseValeur}}">
                      </div>
                    </div>
                  </th>
                  <th></th>
                </tr>
                <tr>
                  <th colspan="3">Total</th>
                  <th id="">
                    <div class="form-group">
                      <div class="col-sm-10">
                        <input type="number" class="form-control" name="service_total" id="service_total" readonly="" value="{{facture.total}}">
                      </div>
                    </div>
                  </th>
                  <th>
                  </th>
                </tr>
              </tfoot>
            </table>
            <div class="hr-line-dashed"></div>
            <p>Arrêté la présente facture à la somme de <b id="service_somme" style="text-transform: uppercase;">{{facture.somme}}</b> 
            <p>
            <div class="row">
              <div class="col-lg-6 col-lg-push-6">
                <div class="form-group" id="data_1">
                  <label class="font-noraml">Moroni le</label>
                  <div class="input-group date">
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    <input type="text" class="form-control" name="f_date" value="{{ facture.date | date('d/m/Y') }}" required="">
                  </div>
                </div>
              </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="form-group">
              <div class="col-sm-4 col-sm-offset-2">
                    <button class="btn btn-primary demo3">
                        <i class="fa fa-save"></i>
                        Enregistrer les modifications
                    </button>

                    {% if print %}
                      <a href="{{ path('facture_pdf', { id : facture.id }) }}" class="btn btn-info" target="_blank">
                          <i class="fa fa-print"></i>
                          Imprimer
                      </a>
                    {% else %}
                      <div class="row">
                        <div class="col-lg-12">
                          <div class="alert alert-warning">
                              <i class="fa fa-warning"></i>
                              Veuillez créer un modèle pour l'impression
                          </div>
                        </div>
                      </div>
                    {% endif %}
                    {# <button class="btn btn-danger demo4" data-action="">
                        <i class="fa fa-trash"></i>

                        Supprimer
                    </button> #}
                </div>
            </div>
            <input type="hidden" name="list_id" value="{{ list_id }}">
            <input type="hidden" name="" id="id-row-service" value="{{ i - 1 }}">
            <input type="hidden" name="somme" id="id-somme-service" value="{{facture.somme}}">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
